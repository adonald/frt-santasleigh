<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Santa Sleigh Tracker</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family:
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        Helvetica,
        Arial,
        "Helvetica Neue",
        sans-serif;
      background: #001;
      color: white;
    }

    body { height: 100vh; overflow: hidden; }
    #map { height: 100vh; width: 100vw; }

    .status-popup {
      position: absolute;
      top: 24px; left: 50%; transform: translateX(-50%);
      background: rgba(24,24,24,0.93);
      color: #fff;
      padding: 16px 18px 12px 18px;
      font-size: 1.25em;
      font-weight: 700;
      border-radius: 18px;
      box-shadow: 0 4px 32px #0006;
      z-index: 2000;
      text-align: center;
      min-width: 300px;
      max-width: 95vw;
      letter-spacing: 0.01em;
      line-height: 1.25;
    }

    .info-popup {
      position: fixed;
      left: 50%; transform: translateX(-50%);
      bottom: 16px;
      background: rgba(20,20,20,0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 28px #0006;
      z-index: 2000;
      display: inline-flex;
      gap: 12px; align-items: center; flex-wrap: wrap;
      font-size: 0.85em; font-weight: 700;
    }

    .info-popup .controls {
      display: inline-flex; gap: 12px; align-items: center; flex-wrap: nowrap; white-space: nowrap;
    }

    .muted { opacity: .9; font-weight: 600; display: none; }

    .btn {
      background:#0b1220;
      color:#fff;
      border:1px solid #ffffff26;
      border-radius: 10px;
      padding:6px 10px;
      font-size:.85em;
      font-weight:800;
      cursor:pointer;
    }

    .btn:disabled { opacity:.7; cursor:not-allowed; }

    /* ‚≠ê DONATE BUTTON ‚≠ê */
    .donate-box {
      position: fixed;
      bottom: 70px; /* desktop + landscape */
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      text-align: center;
    }

    .donate-btn {
      background: #d31c1c;
      color: #fff;
      font-weight: 800;
      padding: 12px 20px;
      border-radius: 14px;
      text-decoration: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      display: inline-block;
      font-size: 1.05em;
    }

    #snow { position: fixed; inset: 0; z-index: 1000; pointer-events: none; }

    /* üì± Mobile portrait ‚Äî dynamic spacing based on viewport height */
    @media (max-width: 600px) and (orientation: portrait) {

      .status-popup { font-size: 1em; padding: 12px 10px; min-width: 160px; }
      .info-popup { font-size: 0.8em; bottom: 10px; gap: 8px; }

      .donate-box {
        bottom: calc(12vh) !important; /* üìå dynamically perfect on all phones */
      }
    }

  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>

  <div class="status-popup" id="status-box">üéÑ Santa is currently in Lapland preparing for Christmas!</div>

  <!-- ‚≠ê DONATE BUTTON ‚≠ê -->
  <div class="donate-box">
    <a href="https://santa.beverleyroundtable.co.uk/#donate" target="_blank" class="donate-btn">
      üéÅ DONATE & SUPPORT US
    </a>
  </div>

  <div class="info-popup">
    <span class="muted" id="lastUpdated">Last update: ‚Äî</span>
    <span class="muted" id="age">Age: ‚Äî</span>

    <span class="controls">
      <button class="btn" id="followBtn" title="Keep the map centred on Santa">Follow Santa: ON</button>
      <button class="btn" id="recenterBtn" title="Re-centre on Santa">Re-centre</button>
    </span>
  </div>

  <canvas id="snow"></canvas>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const firebaseURL = "https://frt-santas-sleigh-default-rtdb.europe-west1.firebasedatabase.app/location/current.json";

    const REFRESH_MS = 10000;
    const STALE_MS = 5 * 60000;
    const FETCH_TIMEOUT_MS = 7000;

    //const fallbackCoords = { lat: 66.5436, lng: 25.8473 }; //Lapland
    const fallbackCoords = { lat: 51.2149, lng: -0.7989 }; //Farnham
    
    const map = L.map("map").setView([fallbackCoords.lat, fallbackCoords.lng], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const sleighIcon = L.icon({
      iconUrl: "https://i.ibb.co/pvjck0Vg/santa-icon.png",
      iconSize: [32, 32],
      iconAnchor: [32, 32],
      popupAnchor: [0, -32]
    });

    const marker = L.marker([fallbackCoords.lat, fallbackCoords.lng], { icon: sleighIcon })
      .addTo(map)
      .bindPopup("Santa is here!");

    const trail = L.polyline([], { weight: 3, opacity: 0.9 }).addTo(map);

    const statusBox = document.getElementById("status-box");
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const ageEl = document.getElementById('age');
    const followBtn = document.getElementById('followBtn');
    const recenterBtn = document.getElementById('recenterBtn');

    const fmt = new Intl.DateTimeFormat('en-GB', {
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      day: '2-digit', month: 'short', timeZone: 'Europe/London'
    });

    const central_latlngs = [
      [51.2233,-0.78396],
      [51.22308,-0.784],
      [51.22307,-0.78381],
      [51.22305,-0.78314],
      [51.22303,-0.78214],
      [51.22303,-0.78206],
      [51.22303,-0.78198],
      [51.22303,-0.78196],
      [51.22303,-0.78194],
      [51.22303,-0.7819],
      [51.22303,-0.78188],
      [51.22302,-0.78185],
      [51.22301,-0.78183],
      [51.22279,-0.78159],
      [51.22258,-0.78144],
      [51.22246,-0.78134],
      [51.22231,-0.78123],
      [51.2222,-0.78117],
      [51.22213,-0.78112],
      [51.22204,-0.78111],
      [51.22195,-0.7811],
      [51.22172,-0.78114],
      [51.2215,-0.78117],
      [51.22144,-0.78119],
      [51.22109,-0.78125],
      [51.221,-0.78127],
      [51.22072,-0.78129],
      [51.221,-0.78127],
      [51.22109,-0.78125],
      [51.22144,-0.78119],
      [51.2215,-0.78117],
      [51.22172,-0.78114],
      [51.22195,-0.7811],
      [51.22204,-0.78111],
      [51.22213,-0.78112],
      [51.2222,-0.78117],
      [51.22231,-0.78123],
      [51.22246,-0.78134],
      [51.22258,-0.78144],
      [51.22279,-0.78159],
      [51.22301,-0.78183],
      [51.22302,-0.78185],
      [51.22303,-0.78188],
      [51.22303,-0.7819],
      [51.22303,-0.78194],
      [51.22303,-0.78196],
      [51.22303,-0.78198],
      [51.22303,-0.78206],
      [51.22303,-0.78214],
      [51.22305,-0.78314],
      [51.22307,-0.78381],
      [51.22308,-0.784],
      [51.22276,-0.78409],
      [51.22256,-0.78418],
      [51.22225,-0.78432],
      [51.22204,-0.78443],
      [51.22193,-0.78451],
      [51.22189,-0.78426],
      [51.22188,-0.78423],
      [51.22188,-0.78421],
      [51.22187,-0.78418],
      [51.22184,-0.78413],
      [51.22182,-0.7841],
      [51.22161,-0.78388],
      [51.22169,-0.78362],
      [51.22177,-0.78337],
      [51.22181,-0.78326],
      [51.2215,-0.78297],
      [51.22137,-0.78284],
      [51.2215,-0.78297],
      [51.22181,-0.78326],
      [51.22177,-0.78337],
      [51.22169,-0.78362],
      [51.22161,-0.78388],
      [51.22141,-0.78368],
      [51.22122,-0.7835],
      [51.22106,-0.78336],
      [51.22086,-0.78317],
      [51.22071,-0.78304],
      [51.22052,-0.78285],
      [51.22048,-0.78284],
      [51.22045,-0.78284],
      [51.22042,-0.78286],
      [51.22039,-0.78261],
      [51.22039,-0.78254],
      [51.2204,-0.78246],
      [51.22043,-0.78237],
      [51.22048,-0.78227],
      [51.22043,-0.78237],
      [51.2204,-0.78246],
      [51.22039,-0.78254],
      [51.22039,-0.78261],
      [51.22042,-0.78286],
      [51.22038,-0.78288],
      [51.22036,-0.78288],
      [51.22035,-0.7829],
      [51.22032,-0.78295],
      [51.22021,-0.78314],
      [51.21985,-0.78279],
      [51.22021,-0.78314],
      [51.22013,-0.78333],
      [51.22003,-0.78356],
      [51.21995,-0.78373],
      [51.21991,-0.78381],
      [51.21965,-0.78357],
      [51.21991,-0.78381],
      [51.21995,-0.78373],
      [51.22003,-0.78356],
      [51.22013,-0.78333],
      [51.22021,-0.78314],
      [51.22032,-0.78295],
      [51.22035,-0.7829],
      [51.22036,-0.78288],
      [51.22038,-0.78288],
      [51.22042,-0.78286],
      [51.22045,-0.78284],
      [51.22048,-0.78284],
      [51.22052,-0.78285],
      [51.22071,-0.78304],
      [51.22086,-0.78317],
      [51.22106,-0.78336],
      [51.22122,-0.7835],
      [51.22141,-0.78368],
      [51.22161,-0.78388],
      [51.22182,-0.7841],
      [51.22184,-0.78413],
      [51.22187,-0.78418],
      [51.22188,-0.78421],
      [51.22188,-0.78423],
      [51.22189,-0.78426],
      [51.22193,-0.78451],
      [51.22157,-0.78472],
      [51.22114,-0.78503],
      [51.22107,-0.78508],
      [51.22089,-0.78521],
      [51.22075,-0.78537],
      [51.22054,-0.78577],
      [51.22042,-0.78603],
      [51.22036,-0.78618],
      [51.22012,-0.78674],
      [51.22011,-0.78674],
      [51.21986,-0.78716],
      [51.21972,-0.78739],
      [51.21928,-0.78822],
      [51.21916,-0.78855],
      [51.21903,-0.7889],
      [51.21933,-0.78911],
      [51.21948,-0.78921],
      [51.21999,-0.78958],
      [51.22027,-0.78978],
      [51.22032,-0.78981],
      [51.22024,-0.79007],
      [51.2202,-0.79021],
      [51.22005,-0.79056],
      [51.21998,-0.79071],
      [51.21972,-0.79153],
      [51.21965,-0.79153],
      [51.21961,-0.79155],
      [51.21957,-0.79157],
      [51.21954,-0.79159],
      [51.2195,-0.79161],
      [51.21949,-0.79163],
      [51.21948,-0.79164],
      [51.21946,-0.79167],
      [51.21944,-0.79173],
      [51.21945,-0.79184],
      [51.21946,-0.79194],
      [51.21947,-0.79202],
      [51.21949,-0.79207],
      [51.2195,-0.79212],
      [51.21952,-0.79215],
      [51.21954,-0.79218],
      [51.21959,-0.79219],
      [51.21965,-0.79266],
      [51.21966,-0.79276],
      [51.21966,-0.79277],
      [51.21966,-0.79296],
      [51.21965,-0.79301],
      [51.21965,-0.79306],
      [51.21965,-0.7931],
      [51.21964,-0.79313],
      [51.21962,-0.79318],
      [51.21955,-0.7934],
      [51.21938,-0.79383],
      [51.21925,-0.79417],
      [51.2191,-0.79457],
      [51.21889,-0.79438],
      [51.21888,-0.79437],
      [51.21874,-0.79427],
      [51.21851,-0.79412],
      [51.2184,-0.79444],
      [51.21833,-0.79462],
      [51.21828,-0.79476],
      [51.21824,-0.79487],
      [51.21802,-0.79546],
      [51.21792,-0.7954],
      [51.21787,-0.79537],
      [51.21782,-0.79535],
      [51.21775,-0.79533],
      [51.21771,-0.79532],
      [51.21765,-0.79532],
      [51.21757,-0.79533],
      [51.21751,-0.79535],
      [51.21746,-0.79549],
      [51.21741,-0.79566],
      [51.21739,-0.79571],
      [51.21739,-0.79572],
      [51.21739,-0.79582],
      [51.21739,-0.79607],
      [51.21738,-0.7965],
      [51.21737,-0.79662],
      [51.21736,-0.79667],
      [51.21734,-0.79676],
      [51.21729,-0.79691],
      [51.2171,-0.79743],
      [51.21709,-0.79746],
      [51.21707,-0.79748],
      [51.21705,-0.79748],
      [51.21703,-0.79747],
      [51.21681,-0.79727],
      [51.21673,-0.79736],
      [51.21667,-0.79746],
      [51.21662,-0.79747],
      [51.21667,-0.79746],
      [51.21673,-0.79736],
      [51.21681,-0.79727],
      [51.21703,-0.79747],
      [51.21705,-0.79748],
      [51.21707,-0.79748],
      [51.21709,-0.79746],
      [51.2171,-0.79743],
      [51.21729,-0.79691],
      [51.21734,-0.79676],
      [51.21736,-0.79667],
      [51.21737,-0.79662],
      [51.21738,-0.7965],
      [51.21739,-0.79607],
      [51.21739,-0.79582],
      [51.21739,-0.79572],
      [51.21739,-0.79571],
      [51.21741,-0.79566],
      [51.21756,-0.79581],
      [51.21772,-0.79595],
      [51.21808,-0.79628],
      [51.21789,-0.7967],
      [51.21787,-0.79675],
      [51.21775,-0.7971],
      [51.2177,-0.79725],
      [51.21761,-0.79758],
      [51.21745,-0.79804],
      [51.21735,-0.79825],
      [51.21731,-0.79835],
      [51.21724,-0.79849],
      [51.21715,-0.79871],
      [51.21714,-0.79872],
      [51.21703,-0.79901],
      [51.217,-0.7991],
      [51.21699,-0.79913],
      [51.21695,-0.79928],
      [51.21688,-0.79945],
      [51.21684,-0.79953],
      [51.21674,-0.79978],
      [51.21657,-0.80023],
    ];

    const central_poly = L.polyline(central_latlngs, {color: 'red',weight: 3,opacity: 0.9,interactive: false}).addTo(map);

    function setLive() {
      marker.getPopup().setContent("üéÅ Santa's Current Location");
      statusBox.textContent = 'üéÖ Santa is out on his sleigh delivering joy!';
    }

    function setLapland(message) {
      marker.getPopup().setContent(message || "üéÑ GPS inactive ‚Äì fallback to Lapland");
      statusBox.textContent = 'üéÑ Santa is currently in Lapland preparing for Christmas!';
    }

    let followSanta = true;

    followBtn.addEventListener('click', () => {
      followSanta = !followSanta;
      followBtn.textContent = `Follow Santa: ${followSanta ? 'ON' : 'OFF'}`;
      if (followSanta) map.panTo(marker.getLatLng());
    });

    map.on('dragstart zoomstart', () => {
      if (followSanta) {
        followSanta = false;
        followBtn.textContent = 'Follow Santa: OFF';
      }
    });

    recenterBtn.addEventListener('click', () => {
      map.panTo(marker.getLatLng());
      followSanta = true;
      followBtn.textContent = 'Follow Santa: ON';
    });

    function animateMarker(from, to, duration = 1000) {
      const start = performance.now();
      function step(now) {
        const t = Math.min(1, (now - start) / duration);
        const lat = from.lat + (to.lat - from.lat) * t;
        const lng = from.lng + (to.lng - from.lng) * t;

        marker.setLatLng([lat, lng]);
        if (followSanta) map.panTo([lat, lng], { animate: false });

        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    let lastPoint = L.latLng(fallbackCoords.lat, fallbackCoords.lng);
    let backoff = REFRESH_MS;

    async function updateLocation() {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), FETCH_TIMEOUT_MS);

      try {
        const response = await fetch(firebaseURL, { cache: 'no-store', signal: controller.signal });
        clearTimeout(timeout);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const raw = await response.json();

        const secretKey = Object.keys(raw)[0];
        const data = raw[secretKey];

        const valid =
          data && typeof data.lat === 'number' &&
          typeof data.lng === 'number' &&
          typeof data.ts === 'string';

        if (!valid) throw new Error('Bad payload');

        const gpsTime = new Date(data.ts).getTime();
        const ageMs = Date.now() - gpsTime;

        if (ageMs < STALE_MS) {
          lastUpdatedEl.style.display = 'inline';
          lastUpdatedEl.textContent = `Last update: ${fmt.format(new Date(gpsTime))}`;

          ageEl.style.display = 'inline';
          ageEl.textContent = `Age: ${Math.floor(ageMs / 1000)}s`;
        } else {
          lastUpdatedEl.style.display = 'none';
          ageEl.style.display = 'none';
        }

        if (ageMs < STALE_MS) {
          const newLatLng = L.latLng(data.lat, data.lng);
          trail.addLatLng(newLatLng);

          animateMarker(lastPoint, newLatLng);
          lastPoint = newLatLng;

          setLive();
          backoff = REFRESH_MS;
          return;
        }

        goFallback('üéÑ GPS inactive ‚Äì fallback to Lapland');

      } catch (e) {
        clearTimeout(timeout);
        console.error("Error:", e);

        goFallback('üéÑ GPS fetch failed ‚Äì fallback to Lapland');
        backoff = Math.min(backoff * 1.5, 60000);

      } finally {
        scheduleNext();
      }
    }

    function goFallback(msg) {
      const next = L.latLng(fallbackCoords.lat, fallbackCoords.lng);
      animateMarker(marker.getLatLng(), next, 600);

      lastUpdatedEl.style.display = 'none';
      ageEl.style.display = 'none';

      setLapland(msg);
    }

    let timer;
    function scheduleNext() {
      clearTimeout(timer);
      timer = setTimeout(updateLocation, backoff);
    }

    setLapland();
    updateLocation();

    const snow = document.getElementById('snow');
    const ctx = snow.getContext('2d');

    function resize() {
      snow.width = window.innerWidth;
      snow.height = window.innerHeight;
    }

    window.addEventListener('resize', resize);
    resize();

    let flakes = Array.from({ length: 120 }, () => ({
      x: Math.random()*snow.width,
      y: Math.random()*snow.height,
      r: Math.random()*2 + 0.8,
      s: Math.random()*0.6 + 0.3,
      a: Math.random()*Math.PI*2
    }));

    (function drawSnow() {
      ctx.clearRect(0,0,snow.width,snow.height);

      for(const f of flakes) {
        f.y += f.s;
        f.x += Math.sin(f.a+=0.01)*0.3;

        if(f.y > snow.height) {
          f.y = -5;
          f.x = Math.random()*snow.width;
        }

        ctx.globalAlpha = 0.9;
        ctx.beginPath();
        ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
        ctx.fillStyle = '#fff';
        ctx.fill();
      }

      requestAnimationFrame(drawSnow);
    })();

  </script>

</body>
</html>
